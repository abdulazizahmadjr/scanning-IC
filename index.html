<!DOCTYPE html>
<html>
<head>
  <title>Barcode Scanner QC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; text-align:center; padding:20px; }
    input, button { padding:10px; margin:5px; width:90%; }
    table { width:100%; margin-top:15px; border-collapse: collapse; }
    th, td { border:1px solid #ccc; padding:8px; }
    button.small { width:auto; padding:5px; }
  </style>
</head>
<body>

<h2>SCAN BARCODE QC</h2>

<input type="text" id="user" placeholder="Nama User">
<input type="text" id="dn" placeholder="DN / SI">

<div id="reader" style="width:100%"></div>

<h3>Hasil Scan:</h3>
<table>
  <thead>
    <tr>
      <th>No</th>
      <th>Barcode</th>
      <th>Edit</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="resultTable"></tbody>
</table>

<button onclick="saveData()">SAVE</button>
<button onclick="resetForm()">RESET</button>

<script>
let scannedData = [];

function onScanSuccess(decodedText) {
  let waktu = new Date().toLocaleString();
  scannedData.push({ barcode: decodedText, waktu: waktu });
  renderTable();
}

function renderTable() {
  let table = document.getElementById("resultTable");
  table.innerHTML = "";

  scannedData.forEach((item, index) => {
    table.innerHTML += `
      <tr>
        <td>${index + 1}</td>
        <td contenteditable="true" oninput="editBarcode(${index}, this.innerText)">
          ${item.barcode}
        </td>
        <td><button class="small" onclick="editFocus(${index})">Edit</button></td>
        <td><button class="small" onclick="deleteRow(${index})">X</button></td>
      </tr>
    `;
  });
}

function editBarcode(index, value) {
  scannedData[index].barcode = value;
}

function editFocus(index) {
  alert("Silakan edit langsung pada kolom barcode.");
}

function deleteRow(index) {
  scannedData.splice(index, 1);
  renderTable();
}

function saveData() {
  let user = document.getElementById("user").value;
  let dn = document.getElementById("dn").value;

  if (!user || !dn) {
    alert("Nama dan DN harus diisi!");
    return;
  }

  scannedData.forEach(item => {
    let formData = new FormData();
    
    formData.append("entry.1225395461", user); // GANTI ENTRY
    formData.append("entry.1370295395", dn);   // GANTI ENTRY
    formData.append("entry.593393835", item.barcode); // GANTI ENTRY
    formData.append("entry.908329718", item.waktu);   // GANTI ENTRY

    fetch("https://docs.google.com/forms/d/e/1FAIpQLScHVUa6eQf4U7DDvBzGZB58Z1TgB_FlYWfb_4_CjMwuq56Hiw/formResponse", {
      method: "POST",
      mode: "no-cors",
      body: formData
    });
  });

  alert("Data berhasil dikirim!");

  // ðŸ”’ LOCK DN & USER
  document.getElementById("dn").readOnly = true;
  document.getElementById("user").readOnly = true;

  scannedData = [];
  renderTable();
}

function resetForm() {
  document.getElementById("dn").readOnly = false;
  document.getElementById("user").readOnly = false;
  document.getElementById("dn").value = "";
  document.getElementById("user").value = "";
  scannedData = [];
  renderTable();
}

let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
scanner.render(onScanSuccess);
</script>

</body>
</html>
